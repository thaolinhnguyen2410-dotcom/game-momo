<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Momo ‚Äì S·∫Øm T·∫øt Th√¥ng Minh</title>
  <style>
    :root{
      --maxw: 480px;
      --pink: #ec52a4;
      --pink2:#ff5fb2;
      --bg: #fde7f2;
      --card: rgba(255,255,255,.88);
      --text: #5b1c3a;
      --muted: rgba(91, 28, 58, .68);
      --shadow: 0 18px 60px rgba(0,0,0,.18);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      display:grid; place-items:center;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 16px;
      color: var(--text);
    }
    .app{
      width:min(92vw,var(--maxw));
      min-height: 82vh;
      border-radius: var(--r);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: linear-gradient(180deg,#ffd3e6,#fde7f2);
      position:relative;
    }
    .topbar{
      padding: 14px 14px 10px;
      display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,.45);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0,0,0,.05);
    }
    .avatar{
      width: 40px; height: 40px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, #fff, #ffd0e3 60%, #ffb2d1);
      display:grid; place-items:center;
      font-weight: 900;
      color: var(--pink);
      flex: 0 0 auto;
    }
    .title{ line-height:1.15; }
    .title b{ font-size:16px; }
    .title div{ font-size:12px; color: var(--muted); margin-top:3px; }
    .chip{
      margin-left:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(0,0,0,.06);
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }

    .screen{ display:none; padding:14px; }
    .screen.active{ display:block; }

    .panel{
      background: var(--card);
      border-radius: var(--r);
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.10);
      border: 1px solid rgba(0,0,0,.06);
    }

    .h1{ font-size:18px; font-weight: 1000; margin:0 0 6px; }
    .p{ margin:0; color: var(--muted); font-size:13px; line-height:1.35; }
    .sp{ height:12px; }

    .btn{
      appearance:none; border:none;
      cursor:pointer;
      background: var(--pink);
      color:#fff;
      font-weight: 1000;
      border-radius: 14px;
      padding: 12px 14px;
      width: 100%;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{ transform: translateY(2px) scale(.99); filter: brightness(.98); }
    .btn.secondary{
      background: rgba(236,82,164,.12);
      color: var(--text);
      border: 1px solid rgba(236,82,164,.28);
    }

    /* Mode */
    .modeGrid{ display:grid; gap:10px; }
    .bigBtn{
      border:none; cursor:pointer;
      border-radius: 18px;
      padding: 14px 14px;
      text-align:left;
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 12px 30px rgba(0,0,0,.10);
      transition: transform .12s ease;
      position: relative;
      overflow:hidden;
    }
    .bigBtn:active{ transform: translateY(2px) scale(.99); }
    .bigBtn b{ display:block; font-size:16px; }
    .bigBtn span{ display:block; font-size:12px; color: var(--muted); margin-top:3px; }

    /* Checklist */
    .checklist{ display:grid; gap:10px; margin-top:10px; }
    .item{
      display:flex; gap:10px; align-items:center;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(0,0,0,.06);
    }
    .item input{ width:18px; height:18px; accent-color: var(--pink); }
    .item .name{ font-weight: 1000; }
    .item .sub{ margin-top:2px; font-size:12px; color: var(--muted); }
    .badge{
      margin-left:auto;
      font-size: 12px;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(236,82,164,.12);
      border: 1px solid rgba(236,82,164,.25);
      color: var(--text);
    }

    /* Chat */
    .chat{ display:grid; gap:10px; }
    .bubbleRow{ display:flex; gap:10px; align-items:flex-end; }
    .bubbleRow.right{ justify-content:flex-end; }
    .bubble{
      max-width: 82%;
      padding: 12px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.3;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    .bubble.user{
      background: linear-gradient(180deg,var(--pink2),var(--pink));
      color:#fff;
      border-top-right-radius: 8px;
    }
    .bubble.bot{
      background: rgba(255,255,255,.94);
      color: var(--text);
      border-top-left-radius: 8px;
    }
    .monoSmall{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* Shop */
    .shopHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .money{ font-weight:1000; color:#7a1e4c; }
    .twoCol{ display:grid; grid-template-columns: 1.2fr .8fr; gap:10px; }
    @media (max-width: 420px){ .twoCol{ grid-template-columns: 1fr; } }

    .tabs{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .tab{
      border:none; cursor:pointer;
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 1000;
      background: rgba(255,255,255,.7);
      border: 1px solid rgba(0,0,0,.06);
      color: var(--muted);
    }
    .tab.active{
      background: rgba(236,82,164,.16);
      border-color: rgba(236,82,164,.35);
      color: var(--text);
    }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .cardShop{
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      display:flex; flex-direction:column; gap:8px;
    }
    .cardShop b{ font-size:14px; }
    .price{ color: var(--muted); font-weight:1000; }
    .q{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    .buy{
      margin-top:auto;
      border:none; cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 1000;
      background: var(--pink);
      color:#fff;
      transition: transform .12s ease, filter .12s ease;
    }
    .buy:active{ transform: translateY(2px) scale(.99); filter: brightness(.98); }
    .buy:disabled{
      background: rgba(236,82,164,.35);
      cursor:not-allowed;
    }

    .side{
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 12px;
    }
    .side b{ font-size: 13px; }
    .side ul{
      margin: 8px 0 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 13px;
    }

    .moniBox{
      margin-top: 10px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    .moniLine{
      display:flex; gap:10px; align-items:flex-start;
    }
    .moniLine .avatar{ width:34px; height:34px; border-radius: 12px; }
    .moniText{ font-size: 13px; color: var(--text); line-height: 1.35; }
    .moniHint{ margin-top:6px; font-size:12px; color: var(--muted); }

    .footerActions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }

    /* Result */
    .resultBox{
      text-align:center;
      padding: 10px 6px;
    }
    .big{
      font-size: 22px;
      font-weight: 1100;
      margin: 0 0 6px;
    }
    .voucher{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 1100;
      background: rgba(236,82,164,.12);
      border: 1px solid rgba(236,82,164,.28);
    }

    /* tiny ‚Äúicon‚Äù */
    .miniSvg{
      width: 42px; height: 42px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, #fff, #ffd0e3 60%, #ffb2d1);
      display:grid; place-items:center;
      border: 1px solid rgba(0,0,0,.06);
      flex: 0 0 auto;
    }
    .miniSvg svg{ width: 28px; height: 28px; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="avatar">m</div>
      <div class="title">
        <b>Tr·ª£ th·ªß AI - Moni</b>
        <div>Tr·ª£ th·ªß AI c√° nh√¢n c·ªßa b·∫°n</div>
      </div>
      <div class="chip" id="chipTop">Ch∆∞a ch·ªçn ch·∫ø ƒë·ªô</div>
    </div>

    <!-- Screen: Mode -->
    <section class="screen active" id="sMode">
      <div class="panel">
        <div class="h1">Ch·ªçn ch·∫ø ƒë·ªô ch∆°i</div>
        <p class="p">M·ª•c ti√™u: mua ƒë·ªß ƒë·ªì T·∫øt <b>kh√¥ng l·ªë ng√¢n s√°ch</b>. Chi ti√™u h·ª£p l√Ω s·∫Ω nh·∫≠n voucher.</p>
      </div>
      <div class="sp"></div>
      <div class="modeGrid">
        <button class="bigBtn" id="btnSolo" type="button">
          <b>C√° nh√¢n</b>
          <span>T·ª± qu·∫£n l√Ω chi ti√™u</span>
        </button>
        <button class="bigBtn" id="btnGroup" type="button">
          <b>Nh√≥m b·∫°n</b>
          <span>C√πng s·∫Øm, nh∆∞ng v·∫´n ph·∫£i c√¢n ƒë·ªëi ti·ªÅn</span>
        </button>
      </div>
      <div class="sp"></div>
      <button class="btn secondary" id="btnHow" type="button">Lu·∫≠t ch∆°i</button>
    </section>

    <!-- Screen: Rules -->
    <section class="screen" id="sRules">
      <div class="panel">
        <div class="h1">Lu·∫≠t ch∆°i nhanh</div>
        <p class="p">
          1) Tick danh s√°ch ƒë·ªì c·∫ßn mua.<br>
          2) Moni s·∫Ω ‚Äúc·∫•p ng√¢n s√°ch‚Äù theo s·ªë m√≥n tick (c√≥ random).<br>
          3) V√†o shop mua t·ª´ng m√≥n (m·ªói m√≥n c√≥ nhi·ªÅu m·ª©c gi√°/ch·∫•t l∆∞·ª£ng).<br>
          4) Mua ƒë·ªß ƒë·ªì + kh√¥ng l·ªë ti·ªÅn => th·∫Øng.<br><br>
          Voucher:<br>
          ‚Ä¢ <b>30.000ƒë</b> n·∫øu v·ª´a ƒë·ªß ti·ªÅn v√† ch·∫•t l∆∞·ª£ng t·ªët.<br>
          ‚Ä¢ <b>20.000ƒë</b> n·∫øu ch·ªâ v·ª´a ƒë·ªß (ch·∫•t l∆∞·ª£ng trung b√¨nh).<br>
          ‚Ä¢ <b>0ƒë</b> n·∫øu l·ªë/thi·∫øu m√≥n => ch∆°i l·∫°i.
        </p>
        <div class="sp"></div>
        <button class="btn" id="btnRulesBack" type="button">Quay l·∫°i</button>
      </div>
    </section>

    <!-- Screen: Checklist -->
    <section class="screen" id="sList">
      <div class="panel">
        <div class="h1">Checklist ƒë·ªì s·∫Øm T·∫øt</div>
        <p class="p">Tick m√≥n b·∫°n mu·ªën mua. M·ªói m√≥n s·∫Ω c·∫ßn mua <b>√≠t nh·∫•t 1 l·ª±a ch·ªçn</b> trong shop.</p>

        <div class="checklist" id="checklist"></div>

        <div class="sp"></div>
        <button class="btn" id="btnToBudget" type="button">Ti·∫øp theo</button>
        <div class="sp"></div>
        <button class="btn secondary" id="btnBackMode" type="button">Quay l·∫°i</button>
      </div>
    </section>

    <!-- Screen: Budget chat -->
    <section class="screen" id="sBudget">
      <div class="panel">
        <div class="chat">
          <div class="bubbleRow right">
            <div class="bubble user" id="bubbleUser"></div>
          </div>

          <div class="bubbleRow">
            <div class="avatar" style="width:34px;height:34px;border-radius:12px;">m</div>
            <div>
              <div class="bubble bot" id="bubbleBot"></div>
              <div class="monoSmall">Now</div>
            </div>
          </div>
        </div>

        <div class="sp"></div>
        <button class="btn" id="btnEnterShop" type="button">V√†o shop</button>
        <div class="sp"></div>
        <button class="btn secondary" id="btnBackList" type="button">Quay l·∫°i</button>
      </div>
    </section>

    <!-- Screen: Shop -->
    <section class="screen" id="sShop">
      <div class="panel">
        <div class="shopHeader">
          <div>
            <div class="h1" style="margin:0">Shop s·∫Øm T·∫øt</div>
            <p class="p" style="margin-top:4px">Mua ƒë·ªß m√≥n ƒë√£ tick. Moni s·∫Ω nh·∫Øc n·∫øu b·∫°n mua qu√° ƒë·∫Øt ho·∫∑c qu√° ‚Äúr·∫ª m√† k√©m‚Äù.</p>
          </div>
          <div class="chip">
            C√≤n l·∫°i: <span class="money" id="moneyLeft">0ƒë</span>
          </div>
        </div>

        <div class="tabs" id="tabs"></div>

        <div class="twoCol">
          <div>
            <div class="grid" id="shopGrid"></div>
          </div>

          <div>
            <div class="side">
              <b>Gi·ªè ƒë·ªì ƒë√£ mua</b>
              <ul id="bagList"></ul>
            </div>

            <div class="moniBox" id="moniBox">
              <div class="moniLine">
                <div class="avatar">m</div>
                <div>
                  <div class="moniText" id="moniText">Ch·ªçn m√≥n ƒë·∫ßu ti√™n nh√©, m√¨nh s·∫Ω h·ªó tr·ª£ b·∫°n c√¢n ti·ªÅn üëÄ</div>
                  <div class="moniHint" id="moniHint">Tip: m√≥n qu√° ƒë·∫Øt c√≥ th·ªÉ khi·∫øn b·∫°n thi·∫øu ti·ªÅn cho m√≥n c√≤n l·∫°i.</div>
                </div>
              </div>
            </div>

            <div class="footerActions">
              <button class="btn secondary" id="btnRestart" type="button">Ch∆°i l·∫°i</button>
              <button class="btn" id="btnFinish" type="button">Ch·∫•m ƒëi·ªÉm</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Screen: Result -->
    <section class="screen" id="sResult">
      <div class="panel resultBox">
        <div class="big" id="resultTitle">K·∫øt qu·∫£</div>
        <p class="p" id="resultDesc"></p>
        <div class="voucher" id="voucherBox" style="display:none;"></div>
        <div class="sp"></div>
        <button class="btn" id="btnPlayAgain" type="button">Ch∆°i l·∫°i</button>
      </div>
    </section>

  </div>

<script>
  // ===== Helpers =====
  const $$ = (q) => document.querySelector(q);
  const vnd = (n) => n.toLocaleString("vi-VN") + "ƒë";
  const randInt = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
  const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];

  function show(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    $$(id).classList.add("active");
  }

  // ===== Game Data =====
  const checklistItems = [
    { id:"ao-dai", name:"√Åo d√†i", sub:"Di·ªán T·∫øt xinh x·∫Øn", minQuality:2, tag:"Trang ph·ª•c" },
    { id:"dao", name:"C√¢y ƒë√†o", sub:"Trang tr√≠ ph√≤ng kh√°ch", minQuality:2, tag:"Trang tr√≠" },
    { id:"quat", name:"C√¢y qu·∫•t", sub:"May m·∫Øn, sung t√∫c", minQuality:2, tag:"Trang tr√≠" },
    { id:"mut", name:"M·ª©t T·∫øt", sub:"ƒê√£i kh√°ch", minQuality:1, tag:"ƒê·ªì ƒÉn" },
    { id:"banh-chung", name:"B√°nh ch∆∞ng", sub:"M√≥n truy·ªÅn th·ªëng", minQuality:1, tag:"ƒê·ªì ƒÉn" },
    { id:"bao-li-xi", name:"Bao l√¨ x√¨", sub:"L·ªôc ƒë·∫ßu nƒÉm", minQuality:1, tag:"Ph·ª• ki·ªán" },
    { id:"nuoc-ngot", name:"N∆∞·ªõc ng·ªçt", sub:"Ti·∫øp kh√°ch", minQuality:1, tag:"ƒê·ªì ƒÉn" },
    { id:"deco", name:"Trang tr√≠", sub:"D√¢y ƒë√®n, decal‚Ä¶", minQuality:1, tag:"Trang tr√≠" }
  ];

  // Base shop templates (price will be randomized a bit per run)
  const baseCatalog = {
    "C√¢y ƒë√†o": [
      { sku:"dao-1", name:"ƒê√†o mini", base: 100000, q:1, icon:"peach" },
      { sku:"dao-2", name:"ƒê√†o v·ª´a", base: 200000, q:2, icon:"peach" },
      { sku:"dao-3", name:"ƒê√†o to", base: 300000, q:3, icon:"peach" }
    ],
    "C√¢y qu·∫•t": [
      { sku:"quat-1", name:"Qu·∫•t mini", base: 120000, q:1, icon:"kumquat" },
      { sku:"quat-2", name:"Qu·∫•t v·ª´a", base: 220000, q:2, icon:"kumquat" },
      { sku:"quat-3", name:"Qu·∫•t bonsai", base: 350000, q:3, icon:"kumquat" }
    ],
    "√Åo d√†i": [
      { sku:"aodai-1", name:"√Åo d√†i basic", base: 150000, q:1, icon:"dress" },
      { sku:"aodai-2", name:"√Åo d√†i hoa", base: 250000, q:2, icon:"dress" },
      { sku:"aodai-3", name:"√Åo d√†i cao c·∫•p", base: 400000, q:3, icon:"dress" }
    ],
    "M·ª©t T·∫øt": [
      { sku:"mut-1", name:"M·ª©t g·ª´ng", base: 50000, q:1, icon:"candy" },
      { sku:"mut-2", name:"M·ª©t d·ª´a", base: 80000, q:2, icon:"candy" },
      { sku:"mut-3", name:"Combo m·ª©t", base: 120000, q:3, icon:"candy" }
    ],
    "ƒê·ªì ƒÉn": [
      { sku:"banh-1", name:"B√°nh ch∆∞ng", base: 90000, q:2, icon:"cake" },
      { sku:"hatdua-1", name:"H·∫°t d∆∞a", base: 35000, q:1, icon:"seed" },
      { sku:"nuoc-1", name:"Th√πng n∆∞·ªõc ng·ªçt", base: 60000, q:1, icon:"drink" }
    ],
    "Ph·ª• ki·ªán": [
      { sku:"lixi-1", name:"Bao l√¨ x√¨", base: 30000, q:1, icon:"envelope" },
      { sku:"decal-1", name:"Decal T·∫øt", base: 40000, q:1, icon:"spark" },
      { sku:"den-1", name:"D√¢y ƒë√®n", base: 70000, q:2, icon:"spark" }
    ],
    "Trang tr√≠": [
      { sku:"hoa-1", name:"B√¨nh hoa", base: 80000, q:1, icon:"spark" },
      { sku:"nen-1", name:"N·∫øn th∆°m", base: 90000, q:1, icon:"spark" },
      { sku:"phao-1", name:"Combo trang tr√≠", base: 140000, q:2, icon:"spark" }
    ]
  };

  function iconSvg(type){
    // Simple inline SVG icons (no need images)
    const common = `fill="none" stroke="rgba(236,82,164,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"`;
    if(type==="peach") return `<svg viewBox="0 0 24 24"><path ${common} d="M12 21c5 0 8-3 8-7 0-5-5-9-8-12-3 3-8 7-8 12 0 4 3 7 8 7z"/><path ${common} d="M12 9c1-3 3-5 6-6"/></svg>`;
    if(type==="kumquat") return `<svg viewBox="0 0 24 24"><path ${common} d="M12 21c4 0 7-3 7-7s-3-10-7-10-7 6-7 10 3 7 7 7z"/><path ${common} d="M12 4c1 1 2 2 4 2"/></svg>`;
    if(type==="dress") return `<svg viewBox="0 0 24 24"><path ${common} d="M8 4l4 3 4-3"/><path ${common} d="M9 7l-3 5 6 9 6-9-3-5"/><path ${common} d="M12 7v4"/></svg>`;
    if(type==="candy") return `<svg viewBox="0 0 24 24"><path ${common} d="M8 8c2-2 6-2 8 0s2 6 0 8-6 2-8 0-2-6 0-8z"/><path ${common} d="M6 10l-2-2"/><path ${common} d="M18 10l2-2"/></svg>`;
    if(type==="cake") return `<svg viewBox="0 0 24 24"><path ${common} d="M4 12h16v8H4z"/><path ${common} d="M6 12c2 2 4 2 6 0s4-2 6 0"/><path ${common} d="M8 7c0 2 2 2 2 0s-2-2 0-4"/><path ${common} d="M14 7c0 2 2 2 2 0s-2-2 0-4"/></svg>`;
    if(type==="seed") return `<svg viewBox="0 0 24 24"><path ${common} d="M12 21c5-3 7-7 7-11 0-3-2-5-7-7-5 2-7 4-7 7 0 4 2 8 7 11z"/></svg>`;
    if(type==="drink") return `<svg viewBox="0 0 24 24"><path ${common} d="M7 3h10l-1 18H8L7 3z"/><path ${common} d="M9 7h6"/><path ${common} d="M12 3v4"/></svg>`;
    if(type==="envelope") return `<svg viewBox="0 0 24 24"><path ${common} d="M4 7h16v12H4z"/><path ${common} d="M4 7l8 7 8-7"/></svg>`;
    return `<svg viewBox="0 0 24 24"><path ${common} d="M12 2l2.5 6.5L21 11l-6.5 2.5L12 20l-2.5-6.5L3 11l6.5-2.5z"/></svg>`;
  }

  // Map checklist -> categories
  const needToCategory = {
    "ao-dai": "√Åo d√†i",
    "dao": "C√¢y ƒë√†o",
    "quat": "C√¢y qu·∫•t",
    "mut": "M·ª©t T·∫øt",
    "banh-chung": "ƒê·ªì ƒÉn",
    "bao-li-xi": "Ph·ª• ki·ªán",
    "nuoc-ngot": "ƒê·ªì ƒÉn",
    "deco": "Trang tr√≠"
  };

  // ===== State =====
  const state = {
    mode: null,
    selected: new Set(),
    budget: 0,
    moneyLeft: 0,
    bag: [], // {category, sku, name, price, q}
    catalogRun: {}, // randomized prices + stock
    requiredCategories: [],
    minQualityByNeed: {}, // needId -> minQuality
    step: "mode"
  };

  // ===== UI refs =====
  const chipTop = $$("#chipTop");
  const checklistEl = $$("#checklist");
  const bubbleUser = $$("#bubbleUser");
  const bubbleBot  = $$("#bubbleBot");
  const moneyLeftEl = $$("#moneyLeft");
  const tabsEl = $$("#tabs");
  const gridEl = $$("#shopGrid");
  const bagEl  = $$("#bagList");
  const moniText = $$("#moniText");
  const moniHint = $$("#moniHint");

  let currentCategory = null;

  // ===== Render checklist =====
  function renderChecklist(){
    checklistEl.innerHTML = "";
    checklistItems.forEach(it=>{
      const row = document.createElement("label");
      row.className = "item";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = state.selected.has(it.id);
      cb.addEventListener("change", ()=>{
        if(cb.checked) state.selected.add(it.id);
        else state.selected.delete(it.id);
        // update count badge live
        updateListHint();
      });

      const text = document.createElement("div");
      text.innerHTML = `<div class="name">${it.name}</div><div class="sub">${it.sub}</div>`;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = `T·ªëi thi·ªÉu ch·∫•t l∆∞·ª£ng: ${it.minQuality}/3`;

      row.appendChild(cb);
      row.appendChild(text);
      row.appendChild(badge);
      checklistEl.appendChild(row);
    });
    updateListHint();
  }

  function updateListHint(){
    const n = state.selected.size;
    const btn = $$("#btnToBudget");
    btn.textContent = n ? `Ti·∫øp theo (ƒë√£ ch·ªçn ${n} m√≥n)` : "Ti·∫øp theo";
  }

  // ===== Budget logic (difficulty) =====
  function computeBudget(){
    const n = Math.max(1, state.selected.size);

    // base + per-item + random => kh√¥ng c·ªë ƒë·ªãnh, kh√≥ ƒëo√°n
    const base = 260000 + randInt(-20000, 30000); // ~240k-290k
    const per = randInt(75000, 120000);          // 75k-120k m·ªói m√≥n
    let budget = base + n * per;

    // "ƒë·ªô kh√≥" ng·∫´u nhi√™n theo mode
    const diff = (state.mode === "Nh√≥m b·∫°n") ? randInt(0, 50000) : randInt(-15000, 35000);
    budget += diff;

    // l√†m tr√≤n 10k cho ƒë·∫πp
    budget = Math.round(budget / 10000) * 10000;
    return budget;
  }

  // ===== Catalog run (random prices + stock) =====
  function buildCatalogRun(){
    const run = {};
    Object.keys(baseCatalog).forEach(cat=>{
      run[cat] = baseCatalog[cat].map(it=>{
        // gi√° dao ƒë·ªông ¬±10%
        const jitter = randInt(-10, 10) / 100;
        let price = Math.round(it.base * (1 + jitter) / 1000) * 1000;

        // th·ªânh tho·∫£ng ‚Äúh·∫øt h√†ng‚Äù ·ªü m·ª©c r·∫ª ƒë·ªÉ game kh√≥ h∆°n
        let inStock = true;
        if(it.q === 1 && Math.random() < 0.28) inStock = false; // 28% h·∫øt h√†ng ƒë·ªì r·∫ª
        if(it.q === 3 && Math.random() < 0.10) inStock = false; // 10% h·∫øt h√†ng ƒë·ªì x·ªãn

        return { ...it, price, inStock };
      });
    });
    return run;
  }

  // ===== Required categories from selected needs =====
  function computeRequiredCategories(){
    const cats = new Set();
    const minByNeed = {};
    checklistItems.forEach(it=>{
      if(state.selected.has(it.id)){
        const cat = needToCategory[it.id];
        cats.add(cat);
        minByNeed[it.id] = it.minQuality;
      }
    });

    // ensure at least 2 categories for fun
    const required = Array.from(cats);
    return { required, minByNeed };
  }

  // ===== Shop UI =====
  function renderTabs(){
    tabsEl.innerHTML = "";

    // show only required categories (plus 1 bonus random category for ‚Äúc√°m d·ªó‚Äù)
    const required = [...state.requiredCategories];

    const allCats = Object.keys(baseCatalog);
    const bonus = pick(allCats.filter(c=>!required.includes(c)));
    const showCats = [...required, bonus];

    // unique
    const uniq = [...new Set(showCats)];

    // default category
    if(!currentCategory) currentCategory = uniq[0];

    uniq.forEach(cat=>{
      const b = document.createElement("button");
      b.className = "tab" + (cat === currentCategory ? " active" : "");
      b.type = "button";
      b.textContent = required.includes(cat) ? cat : (cat + " (Bonus)");
      b.addEventListener("click", ()=>{
        currentCategory = cat;
        renderTabs();
        renderGrid();
        moniSayForCategory(cat);
      });
      tabsEl.appendChild(b);
    });
  }

  function renderGrid(){
    gridEl.innerHTML = "";
    const items = state.catalogRun[currentCategory] || [];

    items.forEach(it=>{
      const card = document.createElement("div");
      card.className = "cardShop";

      const head = document.createElement("div");
      head.style.display = "flex";
      head.style.gap = "10px";
      head.style.alignItems = "center";

      const icon = document.createElement("div");
      icon.className = "miniSvg";
      icon.innerHTML = iconSvg(it.icon);

      const meta = document.createElement("div");
      meta.innerHTML = `<b>${it.name}</b><div class="q">Ch·∫•t l∆∞·ª£ng: ${it.q}/3</div>`;

      head.appendChild(icon);
      head.appendChild(meta);

      const price = document.createElement("div");
      price.className = "price";
      price.textContent = it.inStock ? vnd(it.price) : "H·∫øt h√†ng";

      const buy = document.createElement("button");
      buy.className = "buy";
      buy.type = "button";
      buy.textContent = it.inStock ? "Mua" : "Kh√¥ng mua ƒë∆∞·ª£c";
      buy.disabled = (!it.inStock) || (state.moneyLeft < it.price);

      buy.addEventListener("click", ()=>{
        buyItem(currentCategory, it);
      });

      card.appendChild(head);
      card.appendChild(price);
      card.appendChild(buy);
      gridEl.appendChild(card);
    });
  }

  function updateMoney(){
    moneyLeftEl.textContent = vnd(state.moneyLeft);
  }

  function renderBag(){
    bagEl.innerHTML = "";
    if(state.bag.length === 0){
      const li = document.createElement("li");
      li.textContent = "Ch∆∞a mua g√¨.";
      bagEl.appendChild(li);
      return;
    }

    // show latest first
    [...state.bag].slice().reverse().forEach(x=>{
      const li = document.createElement("li");
      li.textContent = `${x.category}: ${x.name} ‚Äì ${vnd(x.price)} (Q${x.q})`;
      bagEl.appendChild(li);
    });
  }

  // ===== Moni chatbot (rule-based) =====
  function moniSay(text, hint=""){
    moniText.textContent = text;
    moniHint.textContent = hint || "";
  }

  function moniSayForCategory(cat){
    if(state.requiredCategories.includes(cat)){
      moniSay(`Nh·ªõ mua √≠t nh·∫•t 1 m√≥n trong ‚Äú${cat}‚Äù nh√©.`, "Tip: mua qu√° ƒë·∫Øt c√≥ th·ªÉ thi·∫øu ti·ªÅn cho c√°c m√≥n c√≤n l·∫°i.");
    }else{
      moniSay(`M·ª•c ‚Äú${cat} (Bonus)‚Äù l√† ƒë·ªì th√™m th√¥i. C√¢n nh·∫Øc k·ªπ nh√©!`, "Tip: N·∫øu c√≤n √≠t ti·ªÅn th√¨ ƒë·ª´ng mua ƒë·ªì bonus.");
    }
  }

  function buyItem(category, it){
    // if already bought something in this category, allow but warn
    const already = state.bag.filter(x=>x.category===category).length;

    // spend
    state.moneyLeft -= it.price;
    state.bag.push({ category, sku: it.sku, name: it.name, price: it.price, q: it.q });

    updateMoney();
    renderBag();
    renderGrid();

    // Moni logic warnings
    const budget = state.budget;
    const spent = budget - state.moneyLeft;

    if(it.price > budget * 0.45){
      moniSay(
        "M√≥n n√†y h∆°i ƒë·∫Øt ƒë√≥ üò• B·∫°n c√≥ th·ªÉ b·ªã thi·∫øu ti·ªÅn cho m√≥n kh√°c.",
        "G·ª£i √Ω: th·ª≠ ch·ªçn m·ª©c v·ª´a (Q2) ƒë·ªÉ v·∫´n ƒë·∫πp m√† kh√¥ng qu√° l·ªë."
      );
      return;
    }

    if(it.q === 1 && state.requiredCategories.includes(category)){
      moniSay(
        "B·∫°n ƒëang ch·ªçn b·∫£n r·∫ª nh·∫•t. N·∫øu mua nhi·ªÅu m√≥n Q1, cu·ªëi game c√≥ th·ªÉ ch·ªâ nh·∫≠n 20k ho·∫∑c thua v√¨ ch·∫•t l∆∞·ª£ng th·∫•p.",
        "Tip: c√¢n nh·∫Øc n√¢ng 1‚Äì2 m√≥n quan tr·ªçng l√™n Q2."
      );
      return;
    }

    if(already >= 1 && state.requiredCategories.includes(category)){
      moniSay(
        `B·∫°n ƒë√£ mua ${already+1} m√≥n trong ‚Äú${category}‚Äù. C√≥ ch·∫Øc c·∫ßn th√™m kh√¥ng?`,
        "Tip: b·∫°n ch·ªâ c·∫ßn ƒë·ªß m√≥n theo checklist ƒë·ªÉ th·∫Øng."
      );
      return;
    }

    if(state.moneyLeft < budget * 0.15){
      moniSay(
        "B·∫°n s·∫Øp h·∫øt ti·ªÅn r·ªìi ƒë√≥! ∆Øu ti√™n mua ƒë·ªß c√°c m√≥n checklist tr∆∞·ªõc nha.",
        "Tip: chuy·ªÉn sang tab checklist c·∫ßn thi·∫øt, tr√°nh mua bonus."
      );
      return;
    }

    moniSay("Okie, mua th√†nh c√¥ng! Ti·∫øp t·ª•c ch·ªçn m√≥n ti·∫øp theo nh√© üíó", "Tip: nh·ªõ ki·ªÉm tra c√≤n thi·∫øu m√≥n checklist n√†o.");
  }

  // ===== Win/Lose evaluate =====
  function evaluate(){
    const neededCats = state.requiredCategories;

    // must have at least 1 item in each required category
    const boughtCats = new Set(state.bag.map(x=>x.category));
    const missing = neededCats.filter(c=>!boughtCats.has(c));

    const budget = state.budget;
    const spent = budget - state.moneyLeft;

    // quality scoring: average quality on required categories (take best purchase per category)
    let qSum = 0;
    let qCount = 0;
    neededCats.forEach(cat=>{
      const items = state.bag.filter(x=>x.category===cat);
      if(items.length){
        const best = Math.max(...items.map(x=>x.q));
        qSum += best;
        qCount += 1;
      }
    });
    const qAvg = qCount ? (qSum / qCount) : 0;

    // lose conditions
    if(state.moneyLeft < 0){
      return { ok:false, title:"B·∫°n THUA r·ªìi üò≠", desc:`B·∫°n ƒë√£ chi ${vnd(spent)} v∆∞·ª£t ng√¢n s√°ch ${vnd(budget)}. Ch∆°i l·∫°i nh√©!`, voucher:0 };
    }
    if(missing.length){
      return { ok:false, title:"Thi·∫øu m√≥n m·∫•t r·ªìi üò≠", desc:`B·∫°n c√≤n thi·∫øu: ${missing.join(", ")}. H√£y quay l·∫°i shop mua ƒë·ªß ƒë·ªÉ th·∫Øng!`, voucher:0, canBack:true };
    }

    // win tiers
    // 30k: within budget + qAvg >= 2.2 + still has some money left (not s√°t 0)
    if(state.moneyLeft >= 0 && qAvg >= 2.2){
      return { ok:true, title:"TH·∫ÆNG R·ªíI üéâ", desc:`B·∫°n mua ƒë·ªß m√≥n v√† chi ti√™u h·ª£p l√Ω. T·ªïng chi: ${vnd(spent)} / ${vnd(budget)}. Ch·∫•t l∆∞·ª£ng TB: ${qAvg.toFixed(1)}/3.`, voucher:30000 };
    }

    // 20k: within budget but quality not great
    return { ok:true, title:"·ªîN √ÅP üëç", desc:`B·∫°n mua ƒë·ªß m√≥n v√† kh√¥ng l·ªë ng√¢n s√°ch. T·ªïng chi: ${vnd(spent)} / ${vnd(budget)}. Ch·∫•t l∆∞·ª£ng TB: ${qAvg.toFixed(1)}/3.`, voucher:20000 };
  }

  // ===== Flow events =====
  $$("#btnHow").addEventListener("click", ()=> show("#sRules"));
  $$("#btnRulesBack").addEventListener("click", ()=> show("#sMode"));

  $$("#btnSolo").addEventListener("click", ()=>{
    state.mode = "C√° nh√¢n";
    chipTop.textContent = "Ch·∫ø ƒë·ªô: C√° nh√¢n";
    show("#sList");
    resetRunKeepMode();
  });

  $$("#btnGroup").addEventListener("click", ()=>{
    state.mode = "Nh√≥m b·∫°n";
    chipTop.textContent = "Ch·∫ø ƒë·ªô: Nh√≥m b·∫°n";
    show("#sList");
    resetRunKeepMode();
  });

  $$("#btnBackMode").addEventListener("click", ()=> show("#sMode"));
  $$("#btnBackList").addEventListener("click", ()=> show("#sList"));

  $$("#btnToBudget").addEventListener("click", ()=>{
    if(state.selected.size === 0){
      // force choose at least 1
      alert("B·∫°n tick √≠t nh·∫•t 1 m√≥n ƒë·ªÉ ch∆°i nha!");
      return;
    }

    // compute budget + required + catalog
    const { required, minByNeed } = computeRequiredCategories();
    state.requiredCategories = required;
    state.minQualityByNeed = minByNeed;

    state.budget = computeBudget();
    state.moneyLeft = state.budget;
    state.catalogRun = buildCatalogRun();
    state.bag = [];
    currentCategory = null;

    // chat bubbles
    const names = checklistItems.filter(x=>state.selected.has(x.id)).map(x=>x.name);
    bubbleUser.textContent = `M√¨nh mu·ªën mua ƒë·ªì T·∫øt: ${names.join(", ")}.`;
    bubbleBot.innerHTML = `B·∫°n c√≥ <b>${vnd(state.budget)}</b> ƒë·ªÉ mua ƒë·ªì nh√©!`;

    show("#sBudget");
  });

  $$("#btnEnterShop").addEventListener("click", ()=>{
    updateMoney();
    renderBag();
    renderTabs();
    renderGrid();
    moniSay("Ch·ªçn m√≥n ƒë·∫ßu ti√™n nh√©, m√¨nh s·∫Ω h·ªó tr·ª£ b·∫°n c√¢n ti·ªÅn üëÄ", "Tip: ∆∞u ti√™n mua ƒë·ªß m√≥n checklist tr∆∞·ªõc.");
    show("#sShop");
  });

  $$("#btnFinish").addEventListener("click", ()=>{
    const res = evaluate();
    $$("#resultTitle").textContent = res.title;
    $$("#resultDesc").textContent = res.desc;

    const vb = $$("#voucherBox");
    if(res.ok){
      vb.style.display = "inline-flex";
      vb.textContent = `üéÅ Voucher: ${vnd(res.voucher)}`;
    }else{
      vb.style.display = "none";
    }

    // if missing items, allow staying in shop (kh√¥ng √©p sang result)
    if(res.canBack){
      moniSay("B·∫°n c√≤n thi·∫øu m√≥n checklist ƒë√≥!", "H√£y mua ƒë·ªß r·ªìi b·∫•m Ch·∫•m ƒëi·ªÉm l·∫°i nh√©.");
      alert("B·∫°n c√≤n thi·∫øu m√≥n checklist. Mua ƒë·ªß r·ªìi b·∫•m Ch·∫•m ƒëi·ªÉm l·∫°i nha!");
      return;
    }

    show("#sResult");
  });

  $$("#btnPlayAgain").addEventListener("click", ()=>{
    resetAll();
    show("#sMode");
  });

  $$("#btnRestart").addEventListener("click", ()=>{
    resetAll();
    show("#sMode");
  });

  // ===== Reset functions =====
  function resetRunKeepMode(){
    // keep selected if user wants? for now reset selection each time
    state.selected = new Set();
    renderChecklist();
  }

  function resetAll(){
    state.mode = null;
    state.selected = new Set();
    state.budget = 0;
    state.moneyLeft = 0;
    state.bag = [];
    state.catalogRun = {};
    state.requiredCategories = [];
    state.minQualityByNeed = {};
    currentCategory = null;
    chipTop.textContent = "Ch∆∞a ch·ªçn ch·∫ø ƒë·ªô";
    renderChecklist();
  }

  // init
  renderChecklist();
</script>
</body>
</html>
