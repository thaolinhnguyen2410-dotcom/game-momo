<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Momo ‚Äì S·∫Øm T·∫øt Th√¥ng Minh</title>
  <style>
    :root{
      --maxw: 480px;
      --pink:#ec52a4;
      --pink2:#ff74bd;
      --bg:#fde7f2;
      --card: rgba(255,255,255,.92);
      --text:#5b1c3a;
      --muted: rgba(91, 28, 58, .68);
      --shadow: 0 18px 60px rgba(0,0,0,.18);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      display:grid; place-items:center;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 16px;
      color: var(--text);
    }
    .app{
      width:min(92vw,var(--maxw));
      height: min(90vh, 860px);
      border-radius: var(--r);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: linear-gradient(180deg,#ffd3e6,#fde7f2);
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .topbar{
      padding: 14px 14px 12px;
      display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,.45);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0,0,0,.05);
      flex: 0 0 auto;
    }
    .avatar{
      width: 40px; height: 40px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, #fff, #ffd0e3 60%, #ffb2d1);
      display:grid; place-items:center;
      font-weight: 900;
      color: var(--pink);
      flex: 0 0 auto;
      user-select:none;
    }
    .avatar.small{ width:34px;height:34px;border-radius:12px; }
    .title{ line-height:1.15; }
    .title b{ font-size:16px; }
    .title div{ font-size:12px; color: var(--muted); margin-top:3px; }

    .chip{
      margin-left:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(0,0,0,.06);
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
    }

    .screen{
      display:none;
      padding:14px;
      flex: 1 1 auto;
      overflow:auto;
    }
    .screen.active{ display:block; }

    .panel{
      background: var(--card);
      border-radius: var(--r);
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.10);
      border: 1px solid rgba(0,0,0,.06);
    }

    .h1{ font-size:18px; font-weight: 1100; margin:0 0 6px; }
    .p{ margin:0; color: var(--muted); font-size:13px; line-height:1.35; }
    .sp{ height:12px; }

    .btn{
      appearance:none; border:none;
      cursor:pointer;
      background: var(--pink);
      color:#fff;
      font-weight: 1100;
      border-radius: 14px;
      padding: 12px 14px;
      width: 100%;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{ transform: translateY(2px) scale(.99); filter: brightness(.98); }
    .btn.secondary{
      background: rgba(236,82,164,.12);
      color: var(--text);
      border: 1px solid rgba(236,82,164,.28);
    }

    .modeGrid{ display:grid; gap:10px; }
    .bigBtn{
      border:none; cursor:pointer;
      border-radius: 18px;
      padding: 14px 14px;
      text-align:left;
      background: rgba(255,255,255,.90);
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 12px 30px rgba(0,0,0,.10);
      transition: transform .12s ease;
    }
    .bigBtn:active{ transform: translateY(2px) scale(.99); }
    .bigBtn b{ display:block; font-size:16px; }
    .bigBtn span{ display:block; font-size:12px; color: var(--muted); margin-top:3px; }

    /* Checklist */
    .checklist{ display:grid; gap:10px; margin-top:10px; }
    .item{
      display:flex; gap:10px; align-items:center;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.06);
    }
    .item input{ width:18px; height:18px; accent-color: var(--pink); }
    .item .name{ font-weight: 1100; }
    .item .sub{ margin-top:2px; font-size:12px; color: var(--muted); }
    .badge{
      margin-left:auto;
      font-size: 12px;
      font-weight: 1100;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(236,82,164,.12);
      border: 1px solid rgba(236,82,164,.25);
      color: var(--text);
      white-space:nowrap;
    }

    /* Chat */
    .chat{ display:grid; gap:10px; }
    .bubbleRow{ display:flex; gap:10px; align-items:flex-end; }
    .bubbleRow.right{ justify-content:flex-end; }
    .bubble{
      max-width: 86%;
      padding: 12px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.3;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    .bubble.user{
      background: linear-gradient(180deg,var(--pink2),var(--pink));
      color:#fff;
      border-top-right-radius: 8px;
    }
    .bubble.bot{
      background: rgba(255,255,255,.94);
      color: var(--text);
      border-top-left-radius: 8px;
    }
    .monoSmall{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* Shop: FIX scroll + sticky money */
    .shopShell{ padding: 0; overflow:hidden; }
    .shopTop{
      position: sticky; top: 0;
      padding: 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.75);
      border-bottom: 1px solid rgba(0,0,0,.06);
      z-index: 6;
    }
    .money{ font-weight:1100; color:#7a1e4c; }

    .tabs{
      padding: 10px 14px 0;
      display:flex; flex-wrap:wrap; gap:8px;
      background: transparent;
    }
    .tab{
      border:none; cursor:pointer;
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 1100;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(0,0,0,.06);
      color: var(--muted);
      transition: transform .12s ease;
    }
    .tab:active{ transform: translateY(1px); }
    .tab.active{
      background: rgba(236,82,164,.16);
      border-color: rgba(236,82,164,.35);
      color: var(--text);
    }

    .shopBody{
      height: calc(100% - 116px);
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 10px;
      padding: 10px 14px 14px;
      overflow:hidden;
    }
    @media (max-width: 430px){
      .shopBody{
        grid-template-columns: 1fr;
        height: calc(100% - 116px);
      }
    }

    .grid{
      overflow:auto;
      padding-right: 4px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 430px){ .grid{ grid-template-columns: 1fr; } }

    .cardShop{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      display:flex; flex-direction:column; gap:8px;
    }
    .row{ display:flex; gap:10px; align-items:center; }
    .miniSvg{
      width: 42px; height: 42px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, #fff, #ffd0e3 60%, #ffb2d1);
      display:grid; place-items:center;
      border: 1px solid rgba(0,0,0,.06);
      flex: 0 0 auto;
    }
    .miniSvg svg{ width: 28px; height: 28px; }
    .price{ color: var(--muted); font-weight:1100; }
    .tier{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    .buy{
      margin-top:auto;
      border:none; cursor:pointer;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 1100;
      background: var(--pink);
      color:#fff;
      transition: transform .12s ease, filter .12s ease;
    }
    .buy:active{ transform: translateY(2px) scale(.99); filter: brightness(.98); }
    .buy:disabled{ opacity:.45; cursor:not-allowed; }

    .side{
      overflow:auto;
      background: rgba(255,255,255,.80);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 220px;
    }

    .bag{
      margin: 0;
      padding: 0;
      list-style: none;
      display:grid;
      gap:8px;
      max-height: 220px;
      overflow:auto;
    }
    .bagItem{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(0,0,0,.06);
    }
    .bagItem small{ color: var(--muted); font-weight: 900; display:block; margin-top:2px; }
    .removeBtn{
      border: none;
      cursor: pointer;
      font-weight: 1100;
      border-radius: 12px;
      padding: 8px 10px;
      background: rgba(236,82,164,.12);
      border: 1px solid rgba(236,82,164,.25);
      color: var(--text);
      transition: transform .12s ease;
    }
    .removeBtn:active{ transform: translateY(2px) scale(.99); }

    .moniBox{
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    .moniLine{ display:flex; gap:10px; align-items:flex-start; }
    .moniText{ font-size: 13px; color: var(--text); line-height: 1.35; }
    .moniHint{ margin-top:6px; font-size:12px; color: var(--muted); }

    .footerActions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 2px;
    }

    /* Result */
    .resultBox{ text-align:center; padding: 10px 6px; }
    .big{ font-size: 22px; font-weight: 1200; margin: 0 0 6px; }
    .voucher{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 1200;
      background: rgba(236,82,164,.12);
      border: 1px solid rgba(236,82,164,.28);
    }
    .badgeRow{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:10px; }
    .badgeChip{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.8);
      border: 1px solid rgba(0,0,0,.06);
      font-weight: 1100;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="avatar">m</div>
      <div class="title">
        <b>Tr·ª£ th·ªß AI - Moni</b>
        <div>Tr·ª£ th·ªß AI c√° nh√¢n c·ªßa b·∫°n</div>
      </div>
      <div class="chip" id="chipTop">Ch∆∞a ch·ªçn ch·∫ø ƒë·ªô</div>
    </div>

    <!-- MODE -->
    <section class="screen active" id="sMode">
      <div class="panel">
        <div class="h1">Ch·ªçn ch·∫ø ƒë·ªô ch∆°i</div>
        <p class="p">Mua ƒë·ªß ƒë·ªì T·∫øt, kh√¥ng l·ªë ng√¢n s√°ch. Moni s·∫Ω g·ª£i √Ω ƒë·ªÉ b·∫°n ƒë·∫°t voucher cao.</p>
      </div>
      <div class="sp"></div>
      <div class="modeGrid">
        <button class="bigBtn" id="btnSolo" type="button">
          <b>C√° nh√¢n</b>
          <span>Voucher: 20k / 30k</span>
        </button>
        <button class="bigBtn" id="btnGroup" type="button">
          <b>Nh√≥m (gi·∫£ l·∫≠p)</b>
          <span>Voucher: 50k / 80k ‚Ä¢ C·∫ßn ph·ªëi h·ª£p ‚Äúƒë·∫πp m√† v·ª´a t√∫i‚Äù</span>
        </button>
      </div>
      <div class="sp"></div>
      <button class="btn secondary" id="btnHow" type="button">Lu·∫≠t ch∆°i</button>
    </section>

    <!-- RULES -->
    <section class="screen" id="sRules">
      <div class="panel">
        <div class="h1">Lu·∫≠t ch∆°i nhanh</div>
        <p class="p">
          1) Tick m√≥n c·∫ßn mua.<br>
          2) Moni c·∫•p ng√¢n s√°ch theo s·ªë m√≥n (c√≥ random).<br>
          3) V√†o shop mua t·ª´ng m√≥n v·ªõi 3 m·ª©c: <b>Ti·∫øt ki·ªám / V·ª´a ƒë·ªß / X·ªãn</b>.<br>
          4) Mua ƒë·ªß m√≥n + kh√¥ng l·ªë ti·ªÅn => th·∫Øng.<br><br>
          M·∫πo l·∫•y voucher cao: ∆∞u ti√™n 2 m√≥n ‚Äúquan tr·ªçng‚Äù (ƒê√†o + √Åo d√†i) ·ªü m·ª©c <b>V·ª´a ƒë·ªß</b> tr·ªü l√™n.
        </p>
        <div class="sp"></div>
        <button class="btn" id="btnRulesBack" type="button">Quay l·∫°i</button>
      </div>
    </section>

    <!-- LIST -->
    <section class="screen" id="sList">
      <div class="panel">
        <div class="h1">Checklist ƒë·ªì s·∫Øm T·∫øt</div>
        <p class="p">Tick m√≥n b·∫°n mu·ªën mua. M·ªói m√≥n c·∫ßn mua √≠t nh·∫•t 1 l·ª±a ch·ªçn trong shop.</p>
        <div class="checklist" id="checklist"></div>
        <div class="sp"></div>
        <button class="btn" id="btnToBudget" type="button">Ti·∫øp theo</button>
        <div class="sp"></div>
        <button class="btn secondary" id="btnBackMode" type="button">Quay l·∫°i</button>
      </div>
    </section>

    <!-- BUDGET CHAT -->
    <section class="screen" id="sBudget">
      <div class="panel">
        <div class="chat">
          <div class="bubbleRow right">
            <div class="bubble user" id="bubbleUser"></div>
          </div>

          <div class="bubbleRow">
            <div class="avatar small">m</div>
            <div>
              <div class="bubble bot" id="bubbleBot"></div>
              <div class="monoSmall">Now</div>
            </div>
          </div>
        </div>

        <div class="sp"></div>
        <button class="btn" id="btnEnterShop" type="button">V√†o shop</button>
        <div class="sp"></div>
        <button class="btn secondary" id="btnBackList" type="button">Quay l·∫°i</button>
      </div>
    </section>

    <!-- SHOP -->
    <section class="screen shopShell" id="sShop">
      <div class="shopTop">
        <div>
          <div class="h1" style="margin:0">Shop s·∫Øm T·∫øt</div>
          <p class="p" style="margin-top:4px">Ti·ªÅn c√≤n l·∫°i lu√¥n hi·ªÉn th·ªã. B·∫°n c√≥ th·ªÉ xo√° m√≥n kh·ªèi gi·ªè ƒë·ªÉ ho√†n ti·ªÅn.</p>
        </div>
        <div class="chip">
          C√≤n l·∫°i: <span class="money" id="moneyLeft">0ƒë</span>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>

      <div class="shopBody">
        <div class="grid" id="shopGrid"></div>

        <aside class="side">
          <b>Gi·ªè ƒë·ªì</b>
          <ul class="bag" id="bagList"></ul>

          <div class="moniBox">
            <div class="moniLine">
              <div class="avatar small">m</div>
              <div>
                <div class="moniText" id="moniText"></div>
                <div class="moniHint" id="moniHint"></div>
              </div>
            </div>
          </div>

          <div class="footerActions">
            <button class="btn secondary" id="btnRestart" type="button">Ch∆°i l·∫°i</button>
            <button class="btn" id="btnFinish" type="button">Ch·∫•m ƒëi·ªÉm</button>
          </div>
        </aside>
      </div>
    </section>

    <!-- RESULT -->
    <section class="screen" id="sResult">
      <div class="panel resultBox">
        <div class="big" id="resultTitle">K·∫øt qu·∫£</div>
        <p class="p" id="resultDesc"></p>
        <div class="badgeRow" id="badgeRow"></div>
        <div class="voucher" id="voucherBox" style="display:none;"></div>
        <div class="sp"></div>
        <button class="btn" id="btnPlayAgain" type="button">Ch∆°i l·∫°i</button>
      </div>
    </section>
  </div>

<script>
  // ===== Helpers =====
  const $$ = (q) => document.querySelector(q);
  const vnd = (n) => n.toLocaleString("vi-VN") + "ƒë";
  const randInt = (a,b) => Math.floor(Math.random()*(b-a+1))+a;

  function show(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    $$(id).classList.add("active");
  }

  // ===== Game Data =====
  const checklistItems = [
    { id:"dao", name:"C√¢y ƒë√†o", sub:"Trang tr√≠ ph√≤ng kh√°ch (m√≥n quan tr·ªçng)" },
    { id:"ao-dai", name:"√Åo d√†i", sub:"Di·ªán T·∫øt xinh (m√≥n quan tr·ªçng)" },
    { id:"quat", name:"C√¢y qu·∫•t", sub:"May m·∫Øn, sung t√∫c" },
    { id:"mut", name:"M·ª©t T·∫øt", sub:"ƒê√£i kh√°ch" },
    { id:"banh-chung", name:"B√°nh ch∆∞ng", sub:"M√≥n truy·ªÅn th·ªëng" },
    { id:"bao-li-xi", name:"Bao l√¨ x√¨", sub:"L·ªôc ƒë·∫ßu nƒÉm" },
    { id:"nuoc-ngot", name:"N∆∞·ªõc ng·ªçt", sub:"Ti·∫øp kh√°ch" },
    { id:"deco", name:"Trang tr√≠", sub:"D√¢y ƒë√®n, decal‚Ä¶" }
  ];

  // Categories for shop tabs
  const needToCategory = {
    "dao": "C√¢y ƒë√†o",
    "ao-dai": "√Åo d√†i",
    "quat": "C√¢y qu·∫•t",
    "mut": "M·ª©t T·∫øt",
    "banh-chung": "ƒê·ªì ƒÉn",
    "bao-li-xi": "Ph·ª• ki·ªán",
    "nuoc-ngot": "ƒê·ªì ƒÉn",
    "deco": "Trang tr√≠"
  };

  // Tier meanings (replaces Q)
  const tiers = [
    { id:1, name:"Ti·∫øt ki·ªám", factor: 0.75 },
    { id:2, name:"V·ª´a ƒë·ªß",   factor: 1.00 },
    { id:3, name:"X·ªãn",      factor: 1.35 }
  ];

  const baseCatalog = {
    "C√¢y ƒë√†o": [
      { sku:"dao-1", name:"ƒê√†o mini", base: 100000, tier:1, icon:"peach" },
      { sku:"dao-2", name:"ƒê√†o v·ª´a",  base: 200000, tier:2, icon:"peach" },
      { sku:"dao-3", name:"ƒê√†o to",   base: 300000, tier:3, icon:"peach" }
    ],
    "C√¢y qu·∫•t": [
      { sku:"quat-1", name:"Qu·∫•t mini",  base: 120000, tier:1, icon:"kumquat" },
      { sku:"quat-2", name:"Qu·∫•t v·ª´a",   base: 220000, tier:2, icon:"kumquat" },
      { sku:"quat-3", name:"Qu·∫•t bonsai",base: 350000, tier:3, icon:"kumquat" }
    ],
    "√Åo d√†i": [
      { sku:"aodai-1", name:"√Åo d√†i basic",   base: 150000, tier:1, icon:"dress" },
      { sku:"aodai-2", name:"√Åo d√†i hoa",     base: 250000, tier:2, icon:"dress" },
      { sku:"aodai-3", name:"√Åo d√†i cao c·∫•p", base: 400000, tier:3, icon:"dress" }
    ],
    "M·ª©t T·∫øt": [
      { sku:"mut-1", name:"M·ª©t g·ª´ng", base: 50000, tier:1, icon:"candy" },
      { sku:"mut-2", name:"M·ª©t d·ª´a",  base: 80000, tier:2, icon:"candy" },
      { sku:"mut-3", name:"Combo m·ª©t",base: 120000,tier:3, icon:"candy" }
    ],
    "ƒê·ªì ƒÉn": [
      { sku:"banh-1",  name:"B√°nh ch∆∞ng",      base: 90000, tier:2, icon:"cake" },
      { sku:"hatdua-1",name:"H·∫°t d∆∞a",         base: 35000, tier:1, icon:"seed" },
      { sku:"nuoc-1",  name:"Th√πng n∆∞·ªõc ng·ªçt", base: 60000, tier:1, icon:"drink" }
    ],
    "Ph·ª• ki·ªán": [
      { sku:"lixi-1", name:"Bao l√¨ x√¨", base: 30000, tier:1, icon:"envelope" },
      { sku:"decal-1",name:"Decal T·∫øt", base: 40000, tier:1, icon:"spark" },
      { sku:"den-1",  name:"D√¢y ƒë√®n",   base: 70000, tier:2, icon:"spark" }
    ],
    "Trang tr√≠": [
      { sku:"hoa-1",  name:"B√¨nh hoa",       base: 80000, tier:1, icon:"spark" },
      { sku:"nen-1",  name:"N·∫øn th∆°m",       base: 90000, tier:1, icon:"spark" },
      { sku:"combo-1",name:"Combo trang tr√≠",base: 140000,tier:2, icon:"spark" }
    ]
  };

  function iconSvg(type){
    const common = `fill="none" stroke="rgba(236,82,164,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"`;
    if(type==="peach") return `<svg viewBox="0 0 24 24"><path ${common} d="M12 21c5 0 8-3 8-7 0-5-5-9-8-12-3 3-8 7-8 12 0 4 3 7 8 7z"/><path ${common} d="M12 9c1-3 3-5 6-6"/></svg>`;
    if(type==="kumquat") return `<svg viewBox="0 0 24 24"><path ${common} d="M12 21c4 0 7-3 7-7s-3-10-7-10-7 6-7 10 3 7 7 7z"/><path ${common} d="M12 4c1 1 2 2 4 2"/></svg>`;
    if(type==="dress") return `<svg viewBox="0 0 24 24"><path ${common} d="M8 4l4 3 4-3"/><path ${common} d="M9 7l-3 5 6 9 6-9-3-5"/><path ${common} d="M12 7v4"/></svg>`;
    if(type==="candy") return `<svg viewBox="0 0 24 24"><path ${common} d="M8 8c2-2 6-2 8 0s2 6 0 8-6 2-8 0-2-6 0-8z"/><path ${common} d="M6 10l-2-2"/><path ${common} d="M18 10l2-2"/></svg>`;
    if(type==="cake") return `<svg viewBox="0 0 24 24"><path ${common} d="M4 12h16v8H4z"/><path ${common} d="M6 12c2 2 4 2 6 0s4-2 6 0"/><path ${common} d="M8 7c0 2 2 2 2 0s-2-2 0-4"/><path ${common} d="M14 7c0 2 2 2 2 0s-2-2 0-4"/></svg>`;
    if(type==="seed") return `<svg viewBox="0 0 24 24"><path ${common} d="M12 21c5-3 7-7 7-11 0-3-2-5-7-7-5 2-7 4-7 7 0 4 2 8 7 11z"/></svg>`;
    if(type==="drink") return `<svg viewBox="0 0 24 24"><path ${common} d="M7 3h10l-1 18H8L7 3z"/><path ${common} d="M9 7h6"/><path ${common} d="M12 3v4"/></svg>`;
    if(type==="envelope") return `<svg viewBox="0 0 24 24"><path ${common} d="M4 7h16v12H4z"/><path ${common} d="M4 7l8 7 8-7"/></svg>`;
    return `<svg viewBox="0 0 24 24"><path ${common} d="M12 2l2.5 6.5L21 11l-6.5 2.5L12 20l-2.5-6.5L3 11l6.5-2.5z"/></svg>`;
  }

  // ===== State =====
  const state = {
    mode: null, // "solo" | "group"
    selected: new Set(),
    budget: 0,
    moneyLeft: 0,
    bag: [], // {category, sku, name, price, tier}
    catalogRun: {},
    requiredCategories: [],
    currentCategory: null,
    warningsHeeded: 0, // for badges
    warnedExpensive: false
  };

  const chipTop = $$("#chipTop");
  const checklistEl = $$("#checklist");
  const bubbleUser = $$("#bubbleUser");
  const bubbleBot  = $$("#bubbleBot");
  const moneyLeftEl = $$("#moneyLeft");
  const tabsEl = $$("#tabs");
  const gridEl = $$("#shopGrid");
  const bagEl  = $$("#bagList");
  const moniText = $$("#moniText");
  const moniHint = $$("#moniHint");

  // ===== Render checklist =====
  function renderChecklist(){
    checklistEl.innerHTML = "";
    checklistItems.forEach(it=>{
      const row = document.createElement("label");
      row.className = "item";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = state.selected.has(it.id);
      cb.addEventListener("change", ()=>{
        if(cb.checked) state.selected.add(it.id);
        else state.selected.delete(it.id);
        updateListHint();
      });

      const text = document.createElement("div");
      text.innerHTML = `<div class="name">${it.name}</div><div class="sub">${it.sub}</div>`;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = (it.id==="dao" || it.id==="ao-dai")
        ? "M√≥n quan tr·ªçng"
        : "C√≥ th·ªÉ ti·∫øt ki·ªám";

      row.appendChild(cb);
      row.appendChild(text);
      row.appendChild(badge);
      checklistEl.appendChild(row);
    });
    updateListHint();
  }

  function updateListHint(){
    const n = state.selected.size;
    $$("#btnToBudget").textContent = n ? `Ti·∫øp theo (ƒë√£ ch·ªçn ${n} m√≥n)` : "Ti·∫øp theo";
  }

  // ===== Budget (difficulty) =====
  function computeBudget(){
    const n = Math.max(1, state.selected.size);

    // base + per item + random
    const base = state.mode==="group"
      ? 420000 + randInt(-30000, 40000)
      : 280000 + randInt(-20000, 30000);

    const per = state.mode==="group"
      ? randInt(85000, 125000)
      : randInt(70000, 115000);

    let budget = base + n * per;

    // round to 10k
    return Math.round(budget / 10000) * 10000;
  }

  // ===== Catalog run (randomized prices slightly) =====
  function buildCatalogRun(){
    const run = {};
    Object.keys(baseCatalog).forEach(cat=>{
      run[cat] = baseCatalog[cat].map(it=>{
        const jitter = randInt(-8, 10) / 100;
        let price = Math.round(it.base * (1 + jitter) / 1000) * 1000;
        return { ...it, price };
      });
    });
    return run;
  }

  function computeRequiredCategories(){
    const cats = new Set();
    checklistItems.forEach(it=>{
      if(state.selected.has(it.id)){
        cats.add(needToCategory[it.id]);
      }
    });
    return Array.from(cats);
  }

  function tierName(t){
    const found = tiers.find(x=>x.id===t);
    return found ? found.name : "V·ª´a ƒë·ªß";
  }

  function showMoni(text, hint=""){
    moniText.textContent = text;
    moniHint.textContent = hint;
  }

  // ===== Shop UI =====
  function renderTabs(){
    tabsEl.innerHTML = "";
    const required = [...state.requiredCategories];

    // tabs = required only (no bonus tab to keep it clear)
    const cats = required.slice();

    if(!state.currentCategory) state.currentCategory = cats[0];

    cats.forEach(cat=>{
      const b = document.createElement("button");
      b.className = "tab" + (cat === state.currentCategory ? " active" : "");
      b.type = "button";
      b.textContent = cat;
      b.addEventListener("click", ()=>{
        state.currentCategory = cat;
        renderTabs();
        renderGrid();
        showMoni(`ƒêang xem: ${cat}`, "M·∫πo: mu·ªën voucher cao, ∆∞u ti√™n ‚Äúƒê√†o‚Äù + ‚Äú√Åo d√†i‚Äù m·ª©c V·ª´a ƒë·ªß tr·ªü l√™n.");
      });
      tabsEl.appendChild(b);
    });
  }

  function renderGrid(){
    gridEl.innerHTML = "";
    const items = state.catalogRun[state.currentCategory] || [];

    items.forEach(it=>{
      const card = document.createElement("div");
      card.className = "cardShop";

      const r = document.createElement("div");
      r.className = "row";

      const icon = document.createElement("div");
      icon.className = "miniSvg";
      icon.innerHTML = iconSvg(it.icon);

      const meta = document.createElement("div");
      meta.innerHTML = `<b>${it.name}</b><div class="tier">${tierName(it.tier)}</div>`;

      r.appendChild(icon);
      r.appendChild(meta);

      const price = document.createElement("div");
      price.className = "price";
      price.textContent = vnd(it.price);

      const buy = document.createElement("button");
      buy.className = "buy";
      buy.type = "button";
      buy.textContent = state.moneyLeft >= it.price ? "Mua" : "Kh√¥ng ƒë·ªß ti·ªÅn";
      buy.disabled = state.moneyLeft < it.price;

      buy.addEventListener("click", ()=> buyItem(state.currentCategory, it));

      card.appendChild(r);
      card.appendChild(price);
      card.appendChild(buy);
      gridEl.appendChild(card);
    });
  }

  function updateMoney(){
    moneyLeftEl.textContent = vnd(state.moneyLeft);
  }

  function renderBag(){
    bagEl.innerHTML = "";
    if(state.bag.length === 0){
      const li = document.createElement("li");
      li.className = "bagItem";
      li.textContent = "Ch∆∞a mua g√¨.";
      bagEl.appendChild(li);
      return;
    }

    state.bag.forEach((x, idx)=>{
      const li = document.createElement("li");
      li.className = "bagItem";

      const left = document.createElement("div");
      left.innerHTML = `<b>${x.category}</b><small>${x.name} ‚Ä¢ ${tierName(x.tier)} ‚Ä¢ ${vnd(x.price)}</small>`;

      const rm = document.createElement("button");
      rm.className = "removeBtn";
      rm.type = "button";
      rm.textContent = "Xo√°";
      rm.addEventListener("click", ()=> removeFromBag(idx));

      li.appendChild(left);
      li.appendChild(rm);
      bagEl.appendChild(li);
    });
  }

  function removeFromBag(index){
    const removed = state.bag.splice(index, 1)[0];
    state.moneyLeft += removed.price;
    updateMoney();
    renderBag();
    renderGrid();

    // If user removed an expensive item after warning, count as heeded
    if(state.warnedExpensive && removed.tier === 3){
      state.warningsHeeded += 1;
      state.warnedExpensive = false;
    }

    showMoni(
      `ƒê√£ xo√° ‚Äú${removed.name}‚Äù. Ho√†n l·∫°i ${vnd(removed.price)}.`,
      "B·∫°n c√≥ th·ªÉ mua l·∫°i l·ª±a ch·ªçn kh√°c ƒë·ªÉ c√¢n ng√¢n s√°ch."
    );
  }

  function missingCategories(){
    const boughtCats = new Set(state.bag.map(x=>x.category));
    return state.requiredCategories.filter(c=>!boughtCats.has(c));
  }

  function bestTierIn(cat){
    const items = state.bag.filter(x=>x.category===cat);
    if(!items.length) return 0;
    return Math.max(...items.map(x=>x.tier));
  }

  function buyItem(category, it){
    // spend + add
    state.moneyLeft -= it.price;
    state.bag.push({ category, sku: it.sku, name: it.name, price: it.price, tier: it.tier });

    updateMoney();
    renderBag();
    renderGrid();

    const miss = missingCategories();

    // Moni strategy: guide for voucher
    const importantCats = ["C√¢y ƒë√†o","√Åo d√†i"];
    const importantGood = importantCats.filter(c => state.requiredCategories.includes(c) ? bestTierIn(c) >= 2 : true).length;
    const totalImportant = importantCats.filter(c => state.requiredCategories.includes(c)).length;

    // warn about expensive
    if(it.tier === 3 && it.price > state.budget * 0.45){
      state.warnedExpensive = true;
      showMoni(
        "M√≥n n√†y kh√° ƒë·∫Øt üò• N·∫øu c√≤n thi·∫øu nhi·ªÅu m√≥n, b·∫°n d·ªÖ b·ªã thi·∫øu ti·ªÅn ƒë√≥.",
        miss.length ? `C√≤n thi·∫øu: ${miss.join(", ")}.` : "B·∫°n ƒë√£ g·∫ßn ƒë·ªß m√≥n r·ªìi."
      );
      return;
    }

    if(miss.length && state.moneyLeft < 90000){
      showMoni(
        "B·∫°n s·∫Øp h·∫øt ti·ªÅn r·ªìi! ∆Øu ti√™n mua c√°c m√≥n checklist c√≤n thi·∫øu nh√©.",
        `C√≤n thi·∫øu: ${miss.join(", ")}`
      );
      return;
    }

    if(totalImportant > 0 && importantGood < totalImportant){
      showMoni(
        "M·∫πo ƒë·ªÉ l·∫•y voucher cao üí°",
        "H√£y c·ªë g·∫Øng ch·ªçn ‚ÄúV·ª´a ƒë·ªß‚Äù cho ƒê√†o + √Åo d√†i (n·∫øu b·∫°n tick). C√°c m√≥n c√≤n l·∫°i c√≥ th·ªÉ ti·∫øt ki·ªám."
      );
      return;
    }

    showMoni(
      "Okie! L·ª±a ch·ªçn ·ªïn √°p üíó",
      miss.length ? `C√≤n thi·∫øu: ${miss.join(", ")}.` : "B·∫°n c√≥ th·ªÉ b·∫•m ‚ÄúCh·∫•m ƒëi·ªÉm‚Äù lu√¥n!"
    );
  }

  // ===== Result evaluate =====
  function computeBadges(res){
    const badges = [];

    // general
    if(res.ok && state.moneyLeft >= state.budget * 0.15) badges.push("ü•á Chi ti√™u k·ª∑ lu·∫≠t");
    if(res.ok && state.moneyLeft <= state.budget * 0.05) badges.push("üéØ C√¢n b·∫±ng ho√†n h·∫£o");
    if(!res.ok) badges.push("üí∏ Tay ti√™u hoang");

    if(state.warningsHeeded >= 1) badges.push("üß† Nghe l·ªùi Moni");

    // quality based
    if(res.ok && res.qualityAvg >= 2.2) badges.push("‚ú® T·∫øt ƒë·∫πp m√† h·ª£p v√≠");
    if(res.ok && res.qualityAvg < 2.2) badges.push("üõçÔ∏è Ti·∫øt ki·ªám v·ª´a ƒë·ªß");

    // ensure at least 2
    while(badges.length < 2 && res.ok) badges.push("üéÄ Ng∆∞·ªùi ch∆°i chƒÉm ch·ªâ");
    return badges.slice(0, 5);
  }

  function evaluate(){
    const budget = state.budget;
    const spent = budget - state.moneyLeft;

    // must have at least 1 item in each required category
    const boughtCats = new Set(state.bag.map(x=>x.category));
    const missing = state.requiredCategories.filter(c=>!boughtCats.has(c));

    if(state.moneyLeft < 0){
      return { ok:false, title:"B·∫°n THUA r·ªìi üò≠", desc:`B·∫°n ƒë√£ chi ${vnd(spent)} v∆∞·ª£t ng√¢n s√°ch ${vnd(budget)}.`, voucher:0 };
    }
    if(missing.length){
      return { ok:false, title:"Thi·∫øu m√≥n üò≠", desc:`B·∫°n c√≤n thi·∫øu: ${missing.join(", ")}.`, voucher:0, canBack:true };
    }

    // Quality avg: best tier per category
    let sum = 0, cnt = 0;
    state.requiredCategories.forEach(cat=>{
      const t = bestTierIn(cat);
      sum += t;
      cnt += 1;
    });
    const qualityAvg = cnt ? (sum / cnt) : 0;

    // Voucher rules
    // Solo: 30k if qualityAvg >= 2.2 else 20k
    // Group: 80k if qualityAvg >= 2.2 else 50k
    let voucher = 0;
    if(state.mode === "group"){
      voucher = (qualityAvg >= 2.2) ? 80000 : 50000;
      return { ok:true, title:"Nh√≥m th·∫Øng üéâ", desc:`T·ªïng chi: ${vnd(spent)} / ${vnd(budget)} ‚Ä¢ ‚Äúƒê·ªô ƒë·∫πp‚Äù TB: ${qualityAvg.toFixed(1)}/3`, voucher, qualityAvg };
    }else{
      voucher = (qualityAvg >= 2.2) ? 30000 : 20000;
      return { ok:true, title:"B·∫°n th·∫Øng üéâ", desc:`T·ªïng chi: ${vnd(spent)} / ${vnd(budget)} ‚Ä¢ ‚Äúƒê·ªô ƒë·∫πp‚Äù TB: ${qualityAvg.toFixed(1)}/3`, voucher, qualityAvg };
    }
  }

  // ===== Buttons =====
  $$("#btnHow").addEventListener("click", ()=> show("#sRules"));
  $$("#btnRulesBack").addEventListener("click", ()=> show("#sMode"));

  $$("#btnSolo").addEventListener("click", ()=>{
    state.mode = "solo";
    chipTop.textContent = "Ch·∫ø ƒë·ªô: C√° nh√¢n";
    resetRun();
    show("#sList");
  });

  $$("#btnGroup").addEventListener("click", ()=>{
    state.mode = "group";
    chipTop.textContent = "Ch·∫ø ƒë·ªô: Nh√≥m (gi·∫£ l·∫≠p)";
    resetRun();
    show("#sList");
  });

  $$("#btnBackMode").addEventListener("click", ()=> show("#sMode"));
  $$("#btnBackList").addEventListener("click", ()=> show("#sList"));

  $$("#btnToBudget").addEventListener("click", ()=>{
    if(state.selected.size === 0){
      alert("B·∫°n tick √≠t nh·∫•t 1 m√≥n ƒë·ªÉ ch∆°i nha!");
      return;
    }

    state.requiredCategories = computeRequiredCategories();
    state.budget = computeBudget();
    state.moneyLeft = state.budget;
    state.catalogRun = buildCatalogRun();
    state.bag = [];
    state.currentCategory = null;
    state.warningsHeeded = 0;
    state.warnedExpensive = false;

    const names = checklistItems.filter(x=>state.selected.has(x.id)).map(x=>x.name);
    bubbleUser.textContent = `M√¨nh mu·ªën mua ƒë·ªì T·∫øt: ${names.join(", ")}.`;

    const modeText = state.mode==="group"
      ? "Ch·∫ø ƒë·ªô nh√≥m: h√£y ∆∞u ti√™n ‚ÄúV·ª´a ƒë·ªß‚Äù cho m√≥n quan tr·ªçng ƒë·ªÉ ƒë·∫°t 80k."
      : "M·∫πo: mu·ªën 30k, ∆∞u ti√™n ‚ÄúV·ª´a ƒë·ªß‚Äù cho ƒê√†o + √Åo d√†i.";

    bubbleBot.innerHTML = `Okie! M√¨nh c·∫•p ng√¢n s√°ch <b>${vnd(state.budget)}</b> nh√©!<br><span style="font-size:12px;color:rgba(91,28,58,.72)">${modeText}</span>`;
    show("#sBudget");
  });

  $$("#btnEnterShop").addEventListener("click", ()=>{
    updateMoney();
    renderBag();
    renderTabs();
    renderGrid();

    showMoni(
      "B·∫Øt ƒë·∫ßu mua nh√©! ∆Øu ti√™n mua ƒë·ªß checklist tr∆∞·ªõc üëÄ",
      "Tip: ƒê√†o + √Åo d√†i ch·ªçn ‚ÄúV·ª´a ƒë·ªß‚Äù l√† d·ªÖ l·∫•y voucher cao."
    );

    show("#sShop");
  });

  $$("#btnFinish").addEventListener("click", ()=>{
    const res = evaluate();

    if(res.canBack){
      showMoni("B·∫°n c√≤n thi·∫øu m√≥n checklist ƒë√≥!", "Mua ƒë·ªß r·ªìi b·∫•m Ch·∫•m ƒëi·ªÉm l·∫°i nh√©.");
      alert("B·∫°n c√≤n thi·∫øu m√≥n checklist. Mua ƒë·ªß r·ªìi b·∫•m Ch·∫•m ƒëi·ªÉm l·∫°i nha!");
      return;
    }

    $$("#resultTitle").textContent = res.title;
    $$("#resultDesc").textContent = res.desc;

    const vb = $$("#voucherBox");
    if(res.ok){
      vb.style.display = "inline-flex";
      vb.textContent = `üéÅ Voucher: ${vnd(res.voucher)}`;
    }else{
      vb.style.display = "none";
    }

    const badges = computeBadges(res);
    const row = $$("#badgeRow");
    row.innerHTML = "";
    badges.forEach(b=>{
      const el = document.createElement("div");
      el.className = "badgeChip";
      el.textContent = b;
      row.appendChild(el);
    });

    show("#sResult");
  });

  function resetRun(){
    state.selected = new Set();
    renderChecklist();
  }

  $$("#btnRestart").addEventListener("click", ()=>{
    location.reload();
  });
  $$("#btnPlayAgain").addEventListener("click", ()=>{
    location.reload();
  });

  // init
  renderChecklist();
</script>
</body>
</html>
