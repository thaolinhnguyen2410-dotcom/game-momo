<script>
/* =========================
   DATA + GAME DESIGN
========================= */
const ITEMS = [
  { id:"banh-chung", name:"BÃ¡nh chÆ°ng", important:true, note:"MÃ³n Táº¿t truyá»n thá»‘ng â€“ Æ°u tiÃªn cháº¥t lÆ°á»£ng." },
  { id:"dao", name:"CÃ¢y Ä‘Ã o", important:true, note:"Trang trÃ­ Táº¿t â€“ Ä‘áº¹p vá»«a Ä‘á»§ lÃ  á»•n." },
  { id:"quat", name:"CÃ¢y quáº¥t", important:true, note:"May máº¯n â€“ Ä‘á»«ng mua quÃ¡ ráº»." },
  { id:"ao-dai", name:"Ão dÃ i", important:true, note:"Diá»‡n Táº¿t â€“ Æ°u tiÃªn ThÆ°á»ng." },
  { id:"mut", name:"Má»©t Táº¿t", important:false, note:"CÃ³ thá»ƒ tiáº¿t kiá»‡m Ä‘á»ƒ dá»“n ngÃ¢n sÃ¡ch." },
  { id:"hat-dua", name:"Háº¡t dÆ°a", important:false, note:"MÃ³n phá»¥ â€“ chá»n tiáº¿t kiá»‡m Ä‘Æ°á»£c." },
  { id:"bao-li-xi", name:"Bao lÃ¬ xÃ¬", important:false, note:"MÃ³n phá»¥ â€“ tiáº¿t kiá»‡m ok." },
  { id:"trang-tri", name:"Trang trÃ­", important:false, note:"ÄÃ¨n/decalâ€¦ mua vá»«a pháº£i." },
];

const TIERS = [
  { tier:1, label:"Tiáº¿t kiá»‡m", emoji:"ğŸŸ¢", quality:1, priceBase: 60000 },
  { tier:2, label:"ThÆ°á»ng",    emoji:"ğŸŸ¡", quality:2, priceBase: 120000 },
  { tier:3, label:"Cao cáº¥p",   emoji:"ğŸ”´", quality:3, priceBase: 210000 },
];

const state = {
  mode: null,
  room: null,
  selected: new Set(),
  requiredNames: [],
  budget: 0,
  moneyLeft: 0,
  bag: [],
  currentTab: null,
  adviceMemory: [],
};

const $ = (id)=>document.getElementById(id);
const vnd = (n)=> n.toLocaleString("vi-VN") + "Ä‘";
const randInt = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];

function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  $(id).classList.add("active");
}

function setChip(text){ $("chipTop").textContent = text; }

function slugRoom(){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out="";
  for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
  return out;
}

function renderChecklist(){
  const el = $("checklist");
  el.innerHTML = "";
  ITEMS.forEach(it=>{
    const row = document.createElement("label");
    row.className = "item";

    const cb = document.createElement("input");
    cb.type="checkbox";
    cb.checked = state.selected.has(it.id);
    cb.addEventListener("change", ()=>{
      if(cb.checked) state.selected.add(it.id);
      else state.selected.delete(it.id);
      updateNextBtn();
    });

    const mid = document.createElement("div");
    mid.innerHTML = `<b>${it.name}${it.important ? " â­" : ""}</b><div class="sub">${it.note}</div>`;

    const tag = document.createElement("div");
    tag.className = "tag badge" + (it.important ? " important":"");
    tag.textContent = it.important ? "Æ¯u tiÃªn: ThÆ°á»ng" : "CÃ³ thá»ƒ tiáº¿t kiá»‡m";

    row.appendChild(cb);
    row.appendChild(mid);
    row.appendChild(tag);
    el.appendChild(row);
  });
  updateNextBtn();
}

function updateNextBtn(){
  const n = state.selected.size;
  $("btnToBudget").textContent = n ? `Tiáº¿p theo (Ä‘Ã£ chá»n ${n} mÃ³n)` : "Tiáº¿p theo";
}

function computeBudget(){
  const n = state.selected.size || 1;
  const base = state.mode === "group" ? 320000 : 260000;
  const perMin = state.mode === "group" ? 105000 : 85000;
  const perMax = state.mode === "group" ? 135000 : 115000;

  let budget = base + n * randInt(perMin, perMax);
  budget += randInt(-20000, 30000);
  return Math.round(budget/10000)*10000;
}

function summarizeSelectedNames(){
  const names = ITEMS.filter(x=>state.selected.has(x.id)).map(x=>x.name);
  state.requiredNames = names;
  return names;
}

function priceFor(itemId, tier){
  const it = ITEMS.find(x=>x.id===itemId);
  const t = TIERS.find(x=>x.tier===tier);
  const impBoost = it.important ? 1.10 : 1.00;
  const jitter = 1 + randInt(-6, 10)/100;
  const base = t.priceBase * impBoost * jitter;
  return Math.round(base/1000)*1000;
}

function tierInfo(tier){ return TIERS.find(x=>x.tier===tier); }

function requiredCategories(){
  return ITEMS.filter(x=>state.selected.has(x.id)).map(x=>x.id);
}

function renderTabs(){
  const tabsEl = $("tabs");
  tabsEl.innerHTML="";
  const ids = requiredCategories();
  if(!ids.length) return;

  if(!state.currentTab) state.currentTab = ids[0];

  ids.forEach(id=>{
    const it = ITEMS.find(x=>x.id===id);
    const b = document.createElement("button");
    b.className = "tab" + (id===state.currentTab ? " active":"");
    b.type="button";
    b.textContent = it.name + (it.important ? " â­" : "");
    b.addEventListener("click", ()=>{
      state.currentTab = id;
      renderTabs();
      renderShopGrid();
      moniAdvise("tab");
    });
    tabsEl.appendChild(b);
  });
}

function renderShopGrid(){
  const grid = $("shopGrid");
  grid.innerHTML = "";

  const itemId = state.currentTab;
  const it = ITEMS.find(x=>x.id===itemId);

  [1,2,3].forEach(tier=>{
    const tInfo = tierInfo(tier);
    const price = priceFor(itemId, tier);

    const card = document.createElement("div");
    card.className="cardShop";

    card.innerHTML = `
      <b>${it.name}</b>
      <div class="meta">${tInfo.emoji} ${tInfo.label} â€¢ GiÃ¡: ${vnd(price)}</div>
      <div class="meta">${
        tier===1 ? "Ráº» â€“ Ä‘á»§ dÃ¹ng â€“ dá»… thiáº¿u Ä‘iá»ƒm voucher cao"
        : tier===2 ? "CÃ¢n báº±ng â€“ Moni khuyÃªn chá»n"
        : "Äáº¹p/xá»‹n â€“ Ä‘áº¯t â€“ coi chá»«ng lá»‘ ngÃ¢n sÃ¡ch"
      }</div>
    `;

    const buy = document.createElement("button");
    buy.className="buyBtn";
    buy.textContent = state.moneyLeft >= price ? "Mua" : "KhÃ´ng Ä‘á»§ tiá»n";
    buy.disabled = state.moneyLeft < price;
    buy.addEventListener("click", ()=> addToBag(itemId, tier, price));

    card.appendChild(buy);
    grid.appendChild(card);
  });
}

function updateMoneyUI(){ $("moneyLeft").textContent = vnd(state.moneyLeft); }

function bestTierBought(itemId){
  const items = state.bag.filter(x=>x.itemId===itemId);
  return items.length ? Math.max(...items.map(x=>x.tier)) : 0;
}

function addToBag(itemId, tier, price){
  const it = ITEMS.find(x=>x.id===itemId);
  const tInfo = tierInfo(tier);

  state.moneyLeft -= price;
  state.bag.push({ itemId, itemName: it.name, tier, label: tInfo.label, price, quality: tInfo.quality });

  updateMoneyUI();
  renderBag();
  renderShopGrid();
  moniAdvise("buy", {itemId, tier, price});
}

function removeFromBag(index){
  const removed = state.bag.splice(index,1)[0];
  state.moneyLeft += removed.price;
  updateMoneyUI();
  renderBag();
  renderShopGrid();
  moniAdvise("remove", removed);
}

function renderBag(){
  const bagEl = $("bagList");
  bagEl.innerHTML="";
  if(state.bag.length===0){
    bagEl.innerHTML = `<li class="bagItem">ChÆ°a mua gÃ¬.</li>`;
    return;
  }
  state.bag.forEach((x, idx)=>{
    const li = document.createElement("li");
    li.className="bagItem";
    li.innerHTML = `<div><b>${x.itemName}</b><small>${x.label} â€¢ ${vnd(x.price)}</small></div>`;
    const rm = document.createElement("button");
    rm.className="removeBtn";
    rm.textContent="XoÃ¡";
    rm.addEventListener("click", ()=>removeFromBag(idx));
    li.appendChild(rm);
    bagEl.appendChild(li);
  });
}

/* ===== Moni Advice ===== */
function moniSay(text, hint=""){ $("moniText").textContent=text; $("moniHint").textContent=hint; }

function remainingRequired(){
  return requiredCategories().filter(id=>bestTierBought(id)===0).map(id=>ITEMS.find(x=>x.id===id).name);
}

function countTier(tier){ return state.bag.filter(x=>x.tier===tier).length; }

function importantProgress(){
  const importantSelected = ITEMS.filter(x=>x.important && state.selected.has(x.id)).map(x=>x.id);
  let good=0, total=importantSelected.length;
  importantSelected.forEach(id=>{ if(bestTierBought(id)>=2) good++; });
  return {good,total};
}

function voucherThresholds(){
  const imp = importantProgress();
  return { needGood: Math.min(2, imp.total) };
}

function diversify(lines){
  const used = new Set(state.adviceMemory.slice(-6));
  const candidates = lines.filter(x=>!used.has(x));
  const chosen = candidates.length ? pick(candidates) : pick(lines);
  state.adviceMemory.push(chosen);
  return chosen;
}

function moniAdvise(type, payload){
  const missing = remainingRequired();
  const spent = state.budget - state.moneyLeft;
  const left = state.moneyLeft;
  const tier1 = countTier(1), tier2 = countTier(2), tier3 = countTier(3);
  const imp = importantProgress();
  const { needGood } = voucherThresholds();

  const targetHigh = state.mode === "group" ? "80k" : "30k";
  const targetMid  = state.mode === "group" ? "50k" : "20k";

  const tooManyCheap = tier1 >= Math.max(3, Math.ceil(state.bag.length*0.6));
  const overspendRisk = left < Math.round(state.budget*0.20);
  const hasAnyPremium = tier3 > 0;

  const baseTips = [
    `Máº¹o láº¥y voucher ${targetHigh}: Æ°u tiÃªn ${needGood} mÃ³n â­ má»©c â€œThÆ°á»ngâ€ trá»Ÿ lÃªn, mÃ³n phá»¥ chá»n â€œTiáº¿t kiá»‡mâ€.`,
    `Muá»‘n ${targetHigh}: nÃ¢ng â€œBÃ¡nh chÆ°ngâ€ hoáº·c â€œÃo dÃ iâ€ lÃªn â€œThÆ°á»ngâ€, má»©t/háº¡t dÆ°a giá»¯ â€œTiáº¿t kiá»‡mâ€ Ä‘á»ƒ cÃ¢n tiá»n.`,
    `Báº¡n Ä‘ang Ä‘i Ä‘Ãºng hÆ°á»›ng. Canh ngÃ¢n sÃ¡ch vÃ  Ä‘áº£m báº£o ${needGood} mÃ³n â­ Ä‘áº¡t â€œThÆ°á»ng+â€ nhÃ©.`,
  ];

  const missingTips = missing.length
    ? [
        `Báº¡n cÃ²n thiáº¿u: ${missing.join(", ")}. Mua Ä‘á»§ checklist trÆ°á»›c Ä‘Ã£ nha.`,
        `Æ¯u tiÃªn mua Ä‘á»§ cÃ¡c mÃ³n cÃ²n thiáº¿u: ${missing.join(", ")}.`,
      ]
    : [
        `Checklist Ä‘á»§ rá»“i âœ… Giá» tá»‘i Æ°u cháº¥t lÆ°á»£ng Ä‘á»ƒ lÃªn voucher ${targetHigh}.`,
        `Báº¡n Ä‘Ã£ mua Ä‘á»§ âœ… Giá» xem láº¡i mÃ³n â­ Ä‘á»ƒ Ä‘áº¡t ${targetHigh} nha.`,
      ];

  const cheapTips = [
    `Báº¡n Ä‘ang mua nhiá»u â€œTiáº¿t kiá»‡mâ€. Náº¿u giá»¯ váº­y thÆ°á»ng chá»‰ Ä‘áº¡t ${targetMid}.`,
    `Thá»­ nÃ¢ng 1â€“2 mÃ³n â­ lÃªn â€œThÆ°á»ngâ€ Ä‘á»ƒ tÄƒng cÆ¡ há»™i Ä‘áº¡t ${targetHigh}.`,
  ];

  const premiumTips = [
    `â€œCao cáº¥pâ€ Ä‘áº¹p nhÆ°ng Ä‘áº¯t. Chá»‰ nÃªn chá»n 1 mÃ³n â€œCao cáº¥pâ€, cÃ²n láº¡i â€œThÆ°á»ngâ€ sáº½ an toÃ n.`,
    `Náº¿u Ä‘Ã£ cÃ³ mÃ³n â€œCao cáº¥pâ€, cÃ¡c mÃ³n cÃ²n láº¡i Æ°u tiÃªn â€œThÆ°á»ngâ€ Ä‘á»ƒ khÃ´ng lá»‘ ngÃ¢n sÃ¡ch.`,
  ];

  const riskTips = [
    `CÃ²n láº¡i ${vnd(left)} thÃ´i ğŸ˜… Æ¯u tiÃªn â€œThÆ°á»ngâ€ cho mÃ³n â­ cÃ²n thiáº¿u, mÃ³n phá»¥ chá»n â€œTiáº¿t kiá»‡mâ€.`,
    `Báº¡n sáº¯p cáº¡n tiá»n. Gá»£i Ã½: BÃ¡nh chÆ°ng/ÄÃ o/Ão dÃ i chá»n â€œThÆ°á»ngâ€, má»©t/bao lÃ¬ xÃ¬ chá»n â€œTiáº¿t kiá»‡mâ€.`,
  ];

  const removeTips = [
    `ÄÃ£ xoÃ¡ âœ… HoÃ n láº¡i ${vnd(payload?.price || 0)}. Giá» báº¡n cÃ¢n Ä‘á»‘i láº¡i Ä‘Æ°á»£c rá»“i.`,
    `XoÃ¡ há»£p lÃ½ Ä‘Ã³. MÃ¬nh canh láº¡i ngÃ¢n sÃ¡ch giÃºp báº¡n nhÃ©.`,
  ];

  let message="", hint="";
  if(type==="remove"){
    message = diversify(removeTips);
    hint = diversify(baseTips);
  } else if(missing.length){
    message = diversify(missingTips);
    hint = diversify(baseTips);
  } else {
    if(imp.good < needGood){
      message = `Muá»‘n voucher ${targetHigh}, báº¡n cáº§n ${needGood} mÃ³n â­ má»©c â€œThÆ°á»ng+â€. Hiá»‡n táº¡i: ${imp.good}/${needGood}.`;
      hint = `Gá»£i Ã½: nÃ¢ng â€œBÃ¡nh chÆ°ngâ€ hoáº·c â€œÃo dÃ iâ€ lÃªn â€œThÆ°á»ngâ€, mÃ³n phá»¥ giá»¯ â€œTiáº¿t kiá»‡mâ€.`;
    } else if(tooManyCheap){
      message = diversify(cheapTips);
      hint = `Tiáº¿t kiá»‡m ${tier1} â€¢ ThÆ°á»ng ${tier2} â€¢ Cao cáº¥p ${tier3}. NÃ¢ng 1 mÃ³n â­ lÃªn â€œThÆ°á»ngâ€ lÃ  Ä‘áº¹p.`;
    } else if(hasAnyPremium && overspendRisk){
      message = diversify(premiumTips);
      hint = diversify(riskTips);
    } else if(overspendRisk){
      message = diversify(riskTips);
      hint = diversify(baseTips);
    } else {
      message = diversify(baseTips);
      hint = `ÄÃ£ chi: ${vnd(spent)} â€¢ CÃ²n: ${vnd(left)} â€¢ MÃ³n â­ â€œThÆ°á»ng+â€: ${imp.good}/${needGood}`;
    }
  }
  moniSay(message, hint);
}

/* ===== Evaluate + Result ===== */
function evaluate(){
  const missing = remainingRequired();
  if(missing.length){
    return { ok:false, title:"ChÆ°a xong ğŸ˜­", desc:`Báº¡n cÃ²n thiáº¿u: ${missing.join(", ")}`, voucher:0, badges:["Thiáº¿u mÃ³n checklist"] };
  }
  if(state.moneyLeft < 0){
    return { ok:false, title:"Lá»‘ ngÃ¢n sÃ¡ch ğŸ˜­", desc:"Báº¡n Ä‘Ã£ chi vÆ°á»£t ngÃ¢n sÃ¡ch.", voucher:0, badges:["Vung tay quÃ¡ trÃ¡n"] };
  }

  const imp = importantProgress();
  const { needGood } = voucherThresholds();
  const tier1 = countTier(1);
  const total = state.bag.length || 1;
  const cheapRatio = tier1 / total;

  const highVoucher = state.mode === "group" ? 80000 : 30000;
  const midVoucher  = state.mode === "group" ? 50000 : 20000;

  const qualifiesHigh = (imp.good >= needGood) && (cheapRatio <= 0.55);
  const voucher = qualifiesHigh ? highVoucher : midVoucher;

  const spent = state.budget - state.moneyLeft;
  const badges = [];
  badges.push(qualifiesHigh ? "ğŸ¯ Chi tiÃªu thÃ´ng minh" : "ğŸ‘ á»”n Ã¡p");
  if(state.moneyLeft >= Math.round(state.budget*0.18)) badges.push("ğŸ’° Ká»· luáº­t");
  if(countTier(3) >= 1) badges.push("âœ¨ CÃ³ mÃ³n xá»‹n");
  if(cheapRatio >= 0.60) badges.push("ğŸŸ¢ SiÃªu tiáº¿t kiá»‡m");

  return {
    ok:true,
    title: qualifiesHigh ? "THáº®NG Lá»šN ğŸ‰" : "THáº®NG ğŸ‘",
    desc:`Tá»•ng chi: ${vnd(spent)} / ${vnd(state.budget)} â€¢ CÃ²n láº¡i: ${vnd(state.moneyLeft)}`,
    voucher,
    badges
  };
}

function parseHashRoom(){
  const h = location.hash || "";
  const m = h.match(/room=([A-Z0-9]{6})/i);
  return m ? m[1].toUpperCase() : null;
}

function setRoom(code){
  state.room = code;
  $("roomCode").textContent = code;
  $("roomInfo").style.display = "block";
  $("roomTip").textContent = `Share link (demo): ${location.origin + location.pathname}#room=${code}`;
}

function resetRunKeepMode(){
  state.selected = new Set();
  state.requiredNames = [];
  state.budget = 0;
  state.moneyLeft = 0;
  state.bag = [];
  state.currentTab = null;
  state.adviceMemory = [];
  renderChecklist();
}

function startMode(mode){
  state.mode = mode;
  if(mode === "solo"){
    setChip("Cháº¿ Ä‘á»™: CÃ¡ nhÃ¢n");
    resetRunKeepMode();
    showScreen("sList");
  } else {
    setChip("Cháº¿ Ä‘á»™: NhÃ³m (demo)");
    showScreen("sRoom");
  }
}

function setupBudgetScreen(){
  const names = summarizeSelectedNames();
  state.budget = computeBudget();
  state.moneyLeft = state.budget;
  state.bag = [];
  state.currentTab = null;
  state.adviceMemory = [];

  $("userBubble").textContent = `MÃ¬nh muá»‘n mua Ä‘á»“ Táº¿t: ${names.join(", ")}.`;

  const targetHigh = state.mode === "group" ? "80k" : "30k";
  const { needGood } = voucherThresholds();

  $("botBubble").innerHTML =
    `Okie! NgÃ¢n sÃ¡ch cá»§a báº¡n lÃ  <b>${vnd(state.budget)}</b> nhÃ©.<br>
     Máº¹o láº¥y voucher <b>${targetHigh}</b>: chá»n Ã­t nháº¥t <b>${needGood}</b> mÃ³n â­ á»Ÿ má»©c <b>ThÆ°á»ng</b> (hoáº·c Cao cáº¥p), mÃ³n phá»¥ cÃ³ thá»ƒ Tiáº¿t kiá»‡m.`;

  showScreen("sBudget");
}

function enterShop(){
  updateMoneyUI();
  renderTabs();
  renderShopGrid();
  renderBag();
  moniAdvise("tab");
  showScreen("sShop");
}

function showResult(res){
  $("resultTitle").textContent = res.title;
  $("resultDesc").textContent = res.desc;

  const row = $("badgeRow");
  row.innerHTML = "";
  res.badges.forEach(b=>{
    const s = document.createElement("div");
    s.className = "badgeChip";
    s.textContent = b;
    row.appendChild(s);
  });

  const vb = $("voucherBox");
  if(res.ok){
    vb.style.display = "inline-flex";
    vb.textContent = `ğŸ Voucher: ${vnd(res.voucher)}`;
  } else {
    vb.style.display = "none";
  }

  showScreen("sResult");
}

/* Wire up */
$("btnSolo").addEventListener("click", ()=> startMode("solo"));
$("btnGroup").addEventListener("click", ()=> startMode("group"));

$("btnHow").addEventListener("click", ()=> showScreen("sRules"));
$("btnRulesBack").addEventListener("click", ()=> showScreen("sMode"));

$("btnBackMode").addEventListener("click", ()=> showScreen("sMode"));
$("btnBackList").addEventListener("click", ()=> showScreen("sList"));

$("btnToBudget").addEventListener("click", ()=>{
  if(state.selected.size === 0){ alert("Báº¡n tick Ã­t nháº¥t 1 mÃ³n Ä‘á»ƒ chÆ¡i nha!"); return; }
  setupBudgetScreen();
});

$("btnEnterShop").addEventListener("click", enterShop);

$("btnRoomBack").addEventListener("click", ()=> showScreen("sMode"));

$("btnCreateRoom").addEventListener("click", ()=> setRoom(slugRoom()));
$("btnJoinRoom").addEventListener("click", ()=>{
  const code = ($("roomInput").value || "").trim().toUpperCase();
  if(!/^[A-Z0-9]{6}$/.test(code)){ alert("MÃ£ phÃ²ng pháº£i 6 kÃ½ tá»± (A-Z, 0-9)."); return; }
  setRoom(code);
});

$("btnCopyLink").addEventListener("click", async ()=>{
  const code = state.room || $("roomCode").textContent;
  const link = location.origin + location.pathname + `#room=${code}`;
  try{ await navigator.clipboard.writeText(link); $("roomTip").textContent="âœ… ÄÃ£ copy link (demo)."; }
  catch{ $("roomTip").textContent="KhÃ´ng copy Ä‘Æ°á»£c. Báº¡n tá»± copy link trÃªn thanh Ä‘á»‹a chá»‰ nha."; }
});

$("btnRoomContinue").addEventListener("click", ()=>{
  resetRunKeepMode();
  showScreen("sList");
});

function hardReset(){
  state.mode = null;
  state.room = null;
  setChip("ChÆ°a chá»n cháº¿ Ä‘á»™");
  resetRunKeepMode();
  $("roomInfo").style.display = "none";
  $("roomInput").value = "";
  history.replaceState(null,"",location.pathname);
  showScreen("sMode");
}

$("btnRestart").addEventListener("click", hardReset);
$("btnPlayAgain").addEventListener("click", hardReset);

$("btnFinish").addEventListener("click", ()=>{
  const res = evaluate();
  if(!res.ok) alert(res.desc);
  showResult(res);
});

/* INIT */
(function init(){
  renderChecklist();
  const room = parseHashRoom();
  if(room){
    startMode("group");
    setRoom(room);
  }
})();
</script>
